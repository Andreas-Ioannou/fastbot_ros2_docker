# Dockerfile.fastbot-ros2-slam-real
FROM ros:humble-ros-base

# Base tools (no build of your packages here)
RUN apt-get update && apt-get install -y --no-install-recommends \
    apt-utils python3-pip python3-rosdep python3-colcon-common-extensions \
    && rm -rf /var/lib/apt/lists/*

# SLAM / Nav2 runtime deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-humble-cartographer \
    ros-humble-cartographer-ros \
    ros-humble-cartographer-ros-msgs \
    ros-humble-navigation2 \
    ros-humble-nav2-bringup \
    ros-humble-nav2-rviz-plugins \
    ros-humble-turtlebot3-msgs \
    ros-humble-tf-transformations \
    ros-humble-rviz2 \
    ros-humble-robot-state-publisher \
    ros-humble-tf2-ros \
    ros-humble-tf2-tools \
    && rm -rf /var/lib/apt/lists/*


SHELL ["/bin/bash", "-c"]

RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-humble-rmw-cyclonedds-cpp && \
    rm -rf /var/lib/apt/lists/*

# Source ROS + mounted workspace for interactive shells
RUN echo "source /opt/ros/humble/setup.bash" >> /root/.bashrc

# Make our config directory and copy the base revo_lds.lua into it
RUN mkdir -p /etc/fastbot && \
    cp /opt/ros/humble/share/cartographer_ros/configuration_files/revo_lds.lua \
       /etc/fastbot/revo_lds.lua

# Our tiny overlay (already in your tree)
COPY revo_lds_nosubdiv.lua /etc/fastbot/revo_lds_nosubdiv.lua

COPY restamp_scan.py /etc/fastbot/restamp_scan.py
RUN chmod +x /etc/fastbot/restamp_scan.py


# Start Cartographer using our overlay (still remapping scan/odom)
CMD \
  source /opt/ros/humble/setup.sh && \
  echo "Starting restamper + Cartographer (revo_lds + no subdivisions)..." && \
  trap 'kill 0' EXIT INT TERM && \
  python3 /etc/fastbot/restamp_scan.py & \
  ros2 run cartographer_ros cartographer_node \
    -configuration_directory /etc/fastbot \
    -configuration_basename revo_lds_nosubdiv.lua \
    -use_sim_time false \
    --ros-args -r scan:=/fastbot/scan_restamped -r odom:=/fastbot/odom & \
  ros2 run cartographer_ros cartographer_occupancy_grid_node \
    --ros-args -p resolution:=0.05 -p publish_period_sec:=1.0 & \
  wait
